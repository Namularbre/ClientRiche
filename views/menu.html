<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDBb-LW0E0EktYw4G7Bb-WxgURITxqUKwE&callback=initMap"></script>
<div id="menu">
    <div id="sidebar">
        <h1>Menu parcelles</h1>
        
        <form method="post" id="formAjoutParcelle">
            <label for="adresse">Adresse</label>
            <input type="text" id="adresse" placeholder="saisir adresse">
            <label for="produit">Produit</label>
            <input type="text" id="produit" placeholder="saisir produit">
            <input type="button" id="ajouterParcelle" value="Creer">
        </form>
        <input type="button" id="afficherFormulaire" value="Ajouter une parcelle">
        <div>
            <ol id="listeParcelle">
            </ol>
        </div>

    </div>
    <div id="map"></div>
</div>
<script>
    let map;
    let geocoder;

    function initMap() {
        geocoder = new google.maps.Geocoder();

        map = new google.maps.Map(document.getElementById('map'), {
            center: { lat: 100, lng: 1 },
            zoom: 6,
        });

        geocoder.geocode({ address: "9 rue Dalloz Limoges" }, function (result, status) {
            if (status == google.maps.GeocoderStatus.OK) {

                if (status != google.maps.GeocoderStatus.ZERO_RESULTS) {

                    map.setCenter(result[0].geometry.location);
                }
            }
        });

        document.querySelectorAll('h2').forEach((address,i) => {
            geocoder.geocode({ address: address.innerText }, function (result, status) {
                if (status == google.maps.GeocoderStatus.OK) {
                    if (status != google.maps.GeocoderStatus.ZERO_RESULTS) {
                        new google.maps.Marker({
                            position: {
                                lat : result[0].geometry.location.lat(),
                                lng : result[0].geometry.location.lng()
                            },
                            map,
                            title: adresse.innerText,
                            label: (i + 1).toString(),
                        });
                    }
                }
            });
        })
    }

    function moveMap(address) {
        geocoder = new google.maps.Geocoder();

        geocoder.geocode({ address }, function (result, status) {
            if (status == google.maps.GeocoderStatus.OK) {
                if (status != google.maps.GeocoderStatus.ZERO_RESULTS) {
                    map.setCenter(result[0].geometry.location);
                    map.setZoom(16);
                }
            }
        });

    }

    function getAdresse() {
        geocoder = new google.maps.Geocoder();
        let resultat = {
            lat: null,
            lng: null,
        };
        return resultat;
    }

    let adresses = $("h2");
    adresses.each((index, adresse) => adresse.on('click', function (event) {
        console.log(index);
        moveMap(adresse.text());
    }))

    /*let adresse = document.querySelectorAll('h2');

    adresses.forEach((adresse) => {
        adresse.addEventListener("click", function (event) {
            moveMap(adresse.innerHTML);
        })
    });*/

    let btnAfficherFormAjoutParcelle = $("#afficherFormulaire");
    btnAfficherFormAjoutParcelle.on('click', function () {
        console.log(btnAfficherFormAjoutParcelle.val());
        btnAfficherFormAjoutParcelle.val(changerTexteBoutonParcelle());
        $("#formAjoutParcelle").toggle();
    })

    function changerTexteBoutonParcelle() {
        if (btnAfficherFormAjoutParcelle.val() == "Cacher parcelle") {
            return "Ajouter une parcelle";
        } else {
            return "Cacher parcelle";
        }
    }

    /*let btnAfficherFormAjoutParcelle = document.getElementById("afficherFormulaire");
    btnAfficherFormAjoutParcelle.addEventListener("click", function (event) {
        if (formAjoutParcelle.style.display == "block") {
            formAjoutParcelle.style.display = "none";
            btnAfficherFormAjoutParcelle.setAttribute('value', "Ajouter parcelle");
        } else {
            formAjoutParcelle.style.display = "block";
            btnAfficherFormAjoutParcelle.setAttribute('value', "cacher formulaire");
        }

    });*/

    let formAjoutParcelle = document.getElementById("formAjoutParcelle");
    let btnAjoutParcelle = document.getElementById("ajouterParcelle");
    btnAjoutParcelle.addEventListener("click", function (event) {
        /*Creation de l'adresse*/
        let nouvelleAdresse = document.getElementById("adresse").value;
        let listeParcelle = document.getElementById("listeParcelle");
        let nouveauLi = document.createElement('li');
        let baliseAdresse = document.createElement('h2');
        baliseAdresse.innerText = nouvelleAdresse;
        nouveauLi.append(baliseAdresse);
        //listeParcelle.append(nouveauLi);

        listeParcelle.addEventListener("click", function (event) {
            moveMap(nouvelleAdresse);
        });
        /*Creation de l'affichage du produit*/
        let nouveauProduit = document.getElementById("produit").value;
        let nouveauP = document.createElement('p');
        nouveauP.innerText = nouveauProduit;
        nouveauLi.append(nouveauP);
        listeParcelle.append(nouveauLi);
    })

</script>

</html>