<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDBb-LW0E0EktYw4G7Bb-WxgURITxqUKwE&callback=initMap"></script>
<script src="./script/trouverParcelle.js"></script>
<script src="./script/ajouterParcelle.js"></script>
<style>
    #formAjoutParcelle{
        display: flex;
        flex-direction: column;
    }
</style>
<div id="menu">
    <div id="sidebar">
        <h1>Ajouter Parcelle</h1>
        <nav class="retour">
            <ul>
                <li class="lien">Retour</li>
            </ul>
        </nav>
        <div>
            <ol id="listeParcelle">
                <!--C'est ici que s'affiche la liste des parcelles-->
            </ol>
        </div>
        <input type="button" id="afficherFormulaire" value="Ajouter une parcelle">
        <form method="post" id="formAjoutParcelle">
            <label for="Numero">Numéro</label>
            <input type="text" id="Numero" placeholder="saisir numéro">
            <label for="typeRue">type de rue</label>
            <select name="typeRue" id="typeRue">
                <option value="null"> ---- </option>
            </select>
            <label for="Adresse">Adresse</label>
            <input type="text" id="Adresse" placeholder="saisir adresse">
            <label for="Codepostal">Code postal</label>
            <input type="text" id="Codepostal" placeholder="saisir code postal">
            <label for="Ville">Ville</label>
            <input type="text" id="Ville" placeholder="saisir ville">
            <label for="Description">Description</label>
            <input type="text" id="Description" placeholder="saisir Description">
            <label for="Libelle">Libelle</label>
            <input type="text" id="Libelle" placeholder="saisir Libelle">
            <input type="button" id="Libelle" value="Creer">
        </form>
    </div>
    <div id="map">
        <!--Ici sera affichée la map-->
    </div>

</div>
<script>
    console.debug(user)
    
    // deplacer la map quand on clique sur une parcelle a gauche
    $(document).on('click', "#menu li", function (event) {
        moveMap(event.currentTarget.childNodes[1].textContent);
    })

    // recuperation et affichage de la liste des parcelles
    $(document).trouverParcelle({
        user,
        success: (parcelle) => {
           $("#listeParcelle").append(`<li class='infoParcelle'><h2>${parcelle?.toString}</h2><h4>${parcelle?.adresse?.toString}</h4></li>`)
        },
        error: (msg) => {
            console.error(msg)
        }
    })
    //recuperation et ajout des types de rue dans le select
    $.ajax({
             url : "http://vps.e-mingo.net/coopagri/app/index.php?&c=api&n=typeRue&x=1",
             crossDomain: true,
             success: function(json) {
               json.data.forEach(type => {
                   console.log("test")
                    $("#typeRue").append(`<option value='${type.id}'>${type.libelle}</option>`)
               })
             },
             error: function(t,e, l) {
               error();
             },
    })

    // ajout de la parcelle dans l'api
    $("#formAjoutParcelle").ajouterParcelle({
        container: "",
        user,
        success: () => {
            alert("parcelle ajoutée !!");
        },
        error : () => {
            alert("Ajout impossible !!");
        }
    })    

    // gestion de la map
    let map;
    let geocoder;

    function initMap() {
        geocoder = new google.maps.Geocoder();

        map = new google.maps.Map(document.getElementById('map'), {
            center: { lat: 100, lng: 1 },
            zoom: 6,
        });

        geocoder.geocode({ address: "9 rue Dalloz Limoges" }, function (result, status) {
            if (status == google.maps.GeocoderStatus.OK) {

                if (status != google.maps.GeocoderStatus.ZERO_RESULTS) {

                    map.setCenter(result[0].geometry.location);
                }
            }
        });
        $('h4').each((i,address) => {
            geocoder.geocode({ address: address.textContent }, function (result, status) {
                if (status == google.maps.GeocoderStatus.OK) {
                    if (status != google.maps.GeocoderStatus.ZERO_RESULTS) {
                        new google.maps.Marker({
                            position: {
                                lat : result[0].geometry.location.lat(),
                                lng : result[0].geometry.location.lng()
                            },
                            map,
                            title: address.innerText,
                            label: (i + 1).toString(),
                        });
                    }
                }
            });
        })
    }
    // fonction pour deplacer la map
    function moveMap(address) {
        geocoder = new google.maps.Geocoder();
        console.log(address)
        geocoder.geocode({ address }, function (result, status) {
            if (status == google.maps.GeocoderStatus.OK) {
                if (status != google.maps.GeocoderStatus.ZERO_RESULTS) {
                    map.setCenter(result[0].geometry.location);
                    map.setZoom(16);
                }
            }
        });
    }

    $("#formAjoutParcelle").hide();
    // ajout parcelle
    let btnAfficherFormAjoutParcelle = $("#afficherFormulaire");
    btnAfficherFormAjoutParcelle.on('click', function () {
        btnAfficherFormAjoutParcelle.val(changerTexteBoutonParcelle());
        $("#formAjoutParcelle").toggle();
    })

    function changerTexteBoutonParcelle() {
        if (btnAfficherFormAjoutParcelle.val() == "Cacher parcelle") {
            return "Ajouter une parcelle";
        } else {
            return "Cacher parcelle";
        }
    }

    let formAjoutParcelle = $("#formAjoutParcelle");
    let btnAjoutParcelle = $("#ajoutParcelle");
    btnAjoutParcelle.on("click", function () {
        console.log("toto");
        let nouvelleAdresse = $("#adresse").text();
        let listeParcelle = $("#listeParcelle");        
        let nouveauProduit = $("produit").text();
        listeParcelle.append("<li><p>" + nouvelleAdresse + "</p><p>"+ nouveauProduit + "</p></li>");
        listeParcelle.on('click', function () {
            moveMap(nouvelleAdresse);
        });
    });

    //Cette fonction sera déclanchée au clique d'une adresse et permetra d'afficher un formulaire de modification
    //Je verrais si on ne met pas direct un bouton.
    function creerFormulaireModification(div) {
        $(this).load($(".infoParcelle"), () => {
            $(".infoParcelle").append("<input type='button' class='btnModifParcelle' value='ModifierParcelle'></input>");
            $(".btnModifParcelle").on('click', () => {
                let parcelleCliquee = { adresse : $(this + ">h4"),
                                        nom :     $(this + ">h2"),
                                    }
                $(this).append("");
            });
        });   
    }
    /*let formAjoutParcelle = document.getElementById("formAjoutParcelle");
    let btnAjoutParcelle = document.getElementById("ajouterParcelle");
    btnAjoutParcelle.addEventListener("click", function (event) {
        //Creation de l'adresse
        let nouvelleAdresse = document.getElementById("adresse").value;
        let listeParcelle = document.getElementById("listeParcelle");
        let nouveauLi = document.createElement('li');
        let baliseAdresse = document.createElement('h2');
        baliseAdresse.innerText = nouvelleAdresse;
        nouveauLi.append(baliseAdresse);
        listeParcelle.addEventListener("click", function (event) {
            moveMap(nouvelleAdresse);
        });
        //Creation de l'affichage du produit
        let nouveauProduit = document.getElementById("produit").value;
        let nouveauP = document.createElement('p');
        nouveauP.innerText = nouveauProduit;
        nouveauLi.append(nouveauP);
        listeParcelle.append(nouveauLi);
    });*/

    // pour pouvoir revenir au menu
    $(this).ready( () => {
        $(".lien").on('click', () => {
            $.get("./views/menu.html", (htmlObtenue) => {
                $("body").html(htmlObtenue);
            });
        });
    });
</script>
</html>